var we=s=>{throw TypeError(s)};var oe=(s,e,t)=>e.has(s)||we("Cannot "+t);var i=(s,e,t)=>(oe(s,e,"read from private field"),t?t.call(s):e.get(s)),p=(s,e,t)=>e.has(s)?we("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),d=(s,e,t,n)=>(oe(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t),g=(s,e,t)=>(oe(s,e,"access private method"),t);import{o as De,p as Oe,q as x,s as ie,v as te,w as ke,x as ce,y as Ie,z as Ke,A as Ve,D as Be,G as Te,H as re,I as Ue,J as je,r as I,K as Ne,M as qe,g as He,a as We,e as Ye,N as ze,Q as z}from"./index-zaywA27-.js";var w,h,X,E,G,q,A,M,Z,H,W,_,k,Q,Y,f,J,ue,le,de,fe,ge,pe,ye,Pe,Ae,$e=(Ae=class extends De{constructor(e,t){super();p(this,f);p(this,w);p(this,h);p(this,X);p(this,E);p(this,G);p(this,q);p(this,A);p(this,M);p(this,Z);p(this,H);p(this,W);p(this,_);p(this,k);p(this,Q);p(this,Y,new Set);this.options=t,d(this,w,e),d(this,M,null),d(this,A,Oe()),this.options.experimental_prefetchInRender||i(this,A).reject(new Error("experimental_prefetchInRender feature flag is not enabled")),this.bindMethods(),this.setOptions(t)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(i(this,h).addObserver(this),Me(i(this,h),this.options)?g(this,f,J).call(this):this.updateResult(),g(this,f,fe).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return me(i(this,h),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return me(i(this,h),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,g(this,f,ge).call(this),g(this,f,pe).call(this),i(this,h).removeObserver(this)}setOptions(e,t){const n=this.options,a=i(this,h);if(this.options=i(this,w).defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof x(this.options.enabled,i(this,h))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");g(this,f,ye).call(this),i(this,h).setOptions(this.options),n._defaulted&&!ie(this.options,n)&&i(this,w).getQueryCache().notify({type:"observerOptionsUpdated",query:i(this,h),observer:this});const c=this.hasListeners();c&&xe(i(this,h),a,this.options,n)&&g(this,f,J).call(this),this.updateResult(t),c&&(i(this,h)!==a||x(this.options.enabled,i(this,h))!==x(n.enabled,i(this,h))||te(this.options.staleTime,i(this,h))!==te(n.staleTime,i(this,h)))&&g(this,f,ue).call(this);const o=g(this,f,le).call(this);c&&(i(this,h)!==a||x(this.options.enabled,i(this,h))!==x(n.enabled,i(this,h))||o!==i(this,Q))&&g(this,f,de).call(this,o)}getOptimisticResult(e){const t=i(this,w).getQueryCache().build(i(this,w),e),n=this.createResult(t,e);return Xe(this,n)&&(d(this,E,n),d(this,q,this.options),d(this,G,i(this,h).state)),n}getCurrentResult(){return i(this,E)}trackResult(e,t){const n={};return Object.keys(e).forEach(a=>{Object.defineProperty(n,a,{configurable:!1,enumerable:!0,get:()=>(this.trackProp(a),t==null||t(a),e[a])})}),n}trackProp(e){i(this,Y).add(e)}getCurrentQuery(){return i(this,h)}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=i(this,w).defaultQueryOptions(e),n=i(this,w).getQueryCache().build(i(this,w),t);return n.fetch().then(()=>this.createResult(n,t))}fetch(e){return g(this,f,J).call(this,{...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),i(this,E)))}createResult(e,t){var Ce;const n=i(this,h),a=this.options,c=i(this,E),o=i(this,G),R=i(this,q),b=e!==n?e.state:i(this,X),{state:m}=e;let r={...m},u=!1,l;if(t._optimisticResults){const S=this.hasListeners(),K=!S&&Me(e,t),V=S&&xe(e,n,t,a);(K||V)&&(r={...r,...Be(m.data,e.options)}),t._optimisticResults==="isRestoring"&&(r.fetchStatus="idle")}let{error:T,errorUpdatedAt:C,status:v}=r;if(t.select&&r.data!==void 0)if(c&&r.data===(o==null?void 0:o.data)&&t.select===i(this,Z))l=i(this,H);else try{d(this,Z,t.select),l=t.select(r.data),l=Te(c==null?void 0:c.data,l,t),d(this,H,l),d(this,M,null)}catch(S){d(this,M,S)}else l=r.data;if(t.placeholderData!==void 0&&l===void 0&&v==="pending"){let S;if(c!=null&&c.isPlaceholderData&&t.placeholderData===(R==null?void 0:R.placeholderData))S=c.data;else if(S=typeof t.placeholderData=="function"?t.placeholderData((Ce=i(this,W))==null?void 0:Ce.state.data,i(this,W)):t.placeholderData,t.select&&S!==void 0)try{S=t.select(S),d(this,M,null)}catch(K){d(this,M,K)}S!==void 0&&(v="success",l=Te(c==null?void 0:c.data,S,t),u=!0)}i(this,M)&&(T=i(this,M),l=i(this,H),C=Date.now(),v="error");const P=r.fetchStatus==="fetching",ne=v==="pending",ae=v==="error",Se=ne&&P,Ee=l!==void 0,U={status:v,fetchStatus:r.fetchStatus,isPending:ne,isSuccess:v==="success",isError:ae,isInitialLoading:Se,isLoading:Se,data:l,dataUpdatedAt:r.dataUpdatedAt,error:T,errorUpdatedAt:C,failureCount:r.fetchFailureCount,failureReason:r.fetchFailureReason,errorUpdateCount:r.errorUpdateCount,isFetched:r.dataUpdateCount>0||r.errorUpdateCount>0,isFetchedAfterMount:r.dataUpdateCount>b.dataUpdateCount||r.errorUpdateCount>b.errorUpdateCount,isFetching:P,isRefetching:P&&!ne,isLoadingError:ae&&!Ee,isPaused:r.fetchStatus==="paused",isPlaceholderData:u,isRefetchError:ae&&Ee,isStale:Re(e,t),refetch:this.refetch,promise:i(this,A)};if(this.options.experimental_prefetchInRender){const S=ee=>{U.status==="error"?ee.reject(U.error):U.data!==void 0&&ee.resolve(U.data)},K=()=>{const ee=d(this,A,U.promise=Oe());S(ee)},V=i(this,A);switch(V.status){case"pending":e.queryHash===n.queryHash&&S(V);break;case"fulfilled":(U.status==="error"||U.data!==V.value)&&K();break;case"rejected":(U.status!=="error"||U.error!==V.reason)&&K();break}}return U}updateResult(e){const t=i(this,E),n=this.createResult(i(this,h),this.options);if(d(this,G,i(this,h).state),d(this,q,this.options),i(this,G).data!==void 0&&d(this,W,i(this,h)),ie(n,t))return;d(this,E,n);const a={},c=()=>{if(!t)return!0;const{notifyOnChangeProps:o}=this.options,R=typeof o=="function"?o():o;if(R==="all"||!R&&!i(this,Y).size)return!0;const y=new Set(R??i(this,Y));return this.options.throwOnError&&y.add("error"),Object.keys(i(this,E)).some(b=>{const m=b;return i(this,E)[m]!==t[m]&&y.has(m)})};(e==null?void 0:e.listeners)!==!1&&c()&&(a.listeners=!0),g(this,f,Pe).call(this,{...a,...e})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&g(this,f,fe).call(this)}},w=new WeakMap,h=new WeakMap,X=new WeakMap,E=new WeakMap,G=new WeakMap,q=new WeakMap,A=new WeakMap,M=new WeakMap,Z=new WeakMap,H=new WeakMap,W=new WeakMap,_=new WeakMap,k=new WeakMap,Q=new WeakMap,Y=new WeakMap,f=new WeakSet,J=function(e){g(this,f,ye).call(this);let t=i(this,h).fetch(this.options,e);return e!=null&&e.throwOnError||(t=t.catch(ke)),t},ue=function(){g(this,f,ge).call(this);const e=te(this.options.staleTime,i(this,h));if(ce||i(this,E).isStale||!Ie(e))return;const n=Ke(i(this,E).dataUpdatedAt,e)+1;d(this,_,setTimeout(()=>{i(this,E).isStale||this.updateResult()},n))},le=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(i(this,h)):this.options.refetchInterval)??!1},de=function(e){g(this,f,pe).call(this),d(this,Q,e),!(ce||x(this.options.enabled,i(this,h))===!1||!Ie(i(this,Q))||i(this,Q)===0)&&d(this,k,setInterval(()=>{(this.options.refetchIntervalInBackground||Ve.isFocused())&&g(this,f,J).call(this)},i(this,Q)))},fe=function(){g(this,f,ue).call(this),g(this,f,de).call(this,g(this,f,le).call(this))},ge=function(){i(this,_)&&(clearTimeout(i(this,_)),d(this,_,void 0))},pe=function(){i(this,k)&&(clearInterval(i(this,k)),d(this,k,void 0))},ye=function(){const e=i(this,w).getQueryCache().build(i(this,w),this.options);if(e===i(this,h))return;const t=i(this,h);d(this,h,e),d(this,X,e.state),this.hasListeners()&&(t==null||t.removeObserver(this),e.addObserver(this))},Pe=function(e){re.batch(()=>{e.listeners&&this.listeners.forEach(t=>{t(i(this,E))}),i(this,w).getQueryCache().notify({query:i(this,h),type:"observerResultsUpdated"})})},Ae);function Je(s,e){return x(e.enabled,s)!==!1&&s.state.data===void 0&&!(s.state.status==="error"&&e.retryOnMount===!1)}function Me(s,e){return Je(s,e)||s.state.data!==void 0&&me(s,e,e.refetchOnMount)}function me(s,e,t){if(x(e.enabled,s)!==!1){const n=typeof t=="function"?t(s):t;return n==="always"||n!==!1&&Re(s,e)}return!1}function xe(s,e,t,n){return(s!==e||x(n.enabled,s)===!1)&&(!t.suspense||s.state.status!=="error")&&Re(s,t)}function Re(s,e){return x(e.enabled,s)!==!1&&s.isStaleByTime(te(e.staleTime,s))}function Xe(s,e){return!ie(s.getCurrentResult(),e)}var D,N,O,L,F,se,be,Qe,Ze=(Qe=class extends De{constructor(e,t){super();p(this,F);p(this,D);p(this,N);p(this,O);p(this,L);d(this,D,e),this.setOptions(t),this.bindMethods(),g(this,F,se).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var n;const t=this.options;this.options=i(this,D).defaultMutationOptions(e),ie(this.options,t)||i(this,D).getMutationCache().notify({type:"observerOptionsUpdated",mutation:i(this,O),observer:this}),t!=null&&t.mutationKey&&this.options.mutationKey&&Ue(t.mutationKey)!==Ue(this.options.mutationKey)?this.reset():((n=i(this,O))==null?void 0:n.state.status)==="pending"&&i(this,O).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=i(this,O))==null||e.removeObserver(this)}onMutationUpdate(e){g(this,F,se).call(this),g(this,F,be).call(this,e)}getCurrentResult(){return i(this,N)}reset(){var e;(e=i(this,O))==null||e.removeObserver(this),d(this,O,void 0),g(this,F,se).call(this),g(this,F,be).call(this)}mutate(e,t){var n;return d(this,L,t),(n=i(this,O))==null||n.removeObserver(this),d(this,O,i(this,D).getMutationCache().build(i(this,D),this.options)),i(this,O).addObserver(this),i(this,O).execute(e)}},D=new WeakMap,N=new WeakMap,O=new WeakMap,L=new WeakMap,F=new WeakSet,se=function(){var t;const e=((t=i(this,O))==null?void 0:t.state)??je();d(this,N,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},be=function(e){re.batch(()=>{var t,n,a,c,o,R,y,b;if(i(this,L)&&this.hasListeners()){const m=i(this,N).variables,r=i(this,N).context;(e==null?void 0:e.type)==="success"?((n=(t=i(this,L)).onSuccess)==null||n.call(t,e.data,m,r),(c=(a=i(this,L)).onSettled)==null||c.call(a,e.data,null,m,r)):(e==null?void 0:e.type)==="error"&&((R=(o=i(this,L)).onError)==null||R.call(o,e.error,m,r),(b=(y=i(this,L)).onSettled)==null||b.call(y,void 0,e.error,m,r))}this.listeners.forEach(m=>{m(i(this,N))})})},Qe),Ge=I.createContext(!1),et=()=>I.useContext(Ge);Ge.Provider;function tt(){let s=!1;return{clearReset:()=>{s=!1},reset:()=>{s=!0},isReset:()=>s}}var st=I.createContext(tt()),it=()=>I.useContext(st);function _e(s,e){return typeof s=="function"?s(...e):!!s}function ve(){}var rt=(s,e)=>{(s.suspense||s.throwOnError||s.experimental_prefetchInRender)&&(e.isReset()||(s.retryOnMount=!1))},nt=s=>{I.useEffect(()=>{s.clearReset()},[s])},at=({result:s,errorResetBoundary:e,throwOnError:t,query:n,suspense:a})=>s.isError&&!e.isReset()&&!s.isFetching&&n&&(a&&s.data===void 0||_e(t,[s.error,n])),ot=s=>{const e=s.staleTime;s.suspense&&(s.staleTime=typeof e=="function"?(...t)=>Math.max(e(...t),1e3):Math.max(e??1e3,1e3),typeof s.gcTime=="number"&&(s.gcTime=Math.max(s.gcTime,1e3)))},ht=(s,e)=>s.isLoading&&s.isFetching&&!e,ct=(s,e)=>(s==null?void 0:s.suspense)&&e.isPending,Le=(s,e,t)=>e.fetchOptimistic(s).catch(()=>{t.clearReset()});function ut(s,e,t){var r,u,l,T,C;const n=Ne(),a=et(),c=it(),o=n.defaultQueryOptions(s);(u=(r=n.getDefaultOptions().queries)==null?void 0:r._experimental_beforeQuery)==null||u.call(r,o),o._optimisticResults=a?"isRestoring":"optimistic",ot(o),rt(o,c),nt(c);const R=!n.getQueryCache().get(o.queryHash),[y]=I.useState(()=>new e(n,o)),b=y.getOptimisticResult(o),m=!a&&s.subscribed!==!1;if(I.useSyncExternalStore(I.useCallback(v=>{const P=m?y.subscribe(re.batchCalls(v)):ve;return y.updateResult(),P},[y,m]),()=>y.getCurrentResult(),()=>y.getCurrentResult()),I.useEffect(()=>{y.setOptions(o,{listeners:!1})},[o,y]),ct(o,b))throw Le(o,y,c);if(at({result:b,errorResetBoundary:c,throwOnError:o.throwOnError,query:n.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw b.error;if((T=(l=n.getDefaultOptions().queries)==null?void 0:l._experimental_afterQuery)==null||T.call(l,o,b),o.experimental_prefetchInRender&&!ce&&ht(b,a)){const v=R?Le(o,y,c):(C=n.getQueryCache().get(o.queryHash))==null?void 0:C.promise;v==null||v.catch(ve).finally(()=>{y.updateResult()})}return o.notifyOnChangeProps?b:y.trackResult(b)}function he(s,e){return ut(s,$e)}function Fe(s,e){const t=Ne(),[n]=I.useState(()=>new Ze(t,s));I.useEffect(()=>{n.setOptions(s)},[n,s]);const a=I.useSyncExternalStore(I.useCallback(o=>n.subscribe(re.batchCalls(o)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),c=I.useCallback((o,R)=>{n.mutate(o,R).catch(ve)},[n]);if(a.error&&_e(n.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}const $={LOGIN:"login",REGISTER:"register",GOOGLE_CALLBACK:"google-callback",VERIFY:{SEND:"verify-email-send",GET:"verify-email-get"}},j={LEARNER:0,INSTRUCTOR:1,ADMIN:2},lt={0:"Learner",1:"Instructor",2:"Admin"},B=qe((s,e)=>({roles:j,roleNames:lt,getRoleName:t=>{const{roleNames:n}=e();return n[t]||"Unknown"},hasRole:(t,n)=>t?(Array.isArray(n)?n:[n]).some(c=>typeof c=="string"?t.role===j[c.toUpperCase()]:t.role===c):!1})),pt=()=>{const{toast:s}=He(),{login:e}=We(),t=Ye(),n=ze(),a=r=>t(r),c=Fe({mutationKey:[$.LOGIN],mutationFn:async r=>await z.post.login(r),onSuccess:async r=>{var l,T;const u=r==null?void 0:r.message;s({title:"Login success",description:u,variant:"success"});try{const C=(l=r==null?void 0:r.data)==null?void 0:l.userDTO;if(!C)throw new Error("User data not found in response");e(C);const v=(T=n.state)==null?void 0:T.from,P=B.getState().getRoleName(C.role);if(console.log("User role:",P),B.getState().hasRole(C,j.ADMIN)){a("/dashboard");return}else if(B.getState().hasRole(C,j.INSTRUCTOR)){a("/dashboard");return}else if(v){a(v);return}a("/")}catch(C){console.error("Authentication error:",C),s({title:"Authentication error",description:C.message||"There was a problem with your authentication",variant:"destructive"})}},onError:r=>{var l;let u="Invalid email, password or your account is not active";r.response?r.response.status===401?u="Invalid credentials. Please check your email and password.":r.response.status===403?u="Your account is not active or has been suspended.":(l=r.response.data)!=null&&l.message&&(u=r.response.data.message):r.request&&(u="Network error. Please check your connection and try again."),s({title:"Login failed",description:u,variant:"destructive"})}}),o=Fe({mutationKey:[$.REGISTER],mutationFn:async r=>{const{confirmPassword:u,...l}=r;return await z.post.register(l)},onSuccess:r=>{s({title:"Registration successful",description:"Your account has been created. Please sign in.",variant:"success"}),a("/signin")},onError:r=>{var u;s({title:"Registration failed",description:((u=r.response)==null?void 0:u.data)||"Something went wrong. Please try again.",variant:"destructive"})}});return{loginMutation:c,registerMutation:o,googleLogin:()=>({initiateGoogleLogin:()=>{try{const u=`${window.location.origin}/signin-google`,T=`http://ssh.phrimp.io.vn:8083/api//Authentication/google-signin?redirect_uri=${encodeURIComponent(u)}&issignin=true`;window.location.href=T}catch{window.location.href="/signin"}}}),useGoogleCallback:()=>he({queryKey:[$.GOOGLE_CALLBACK],queryFn:async()=>await z.get.googleCallback(),enabled:!1,onSuccess:async r=>{try{const u=(r==null?void 0:r.message)||"Google login successful",l=r==null?void 0:r.data;if(!l)throw console.error("No user data found in response",r),new Error("User data not found in response");console.log("Setting user data in auth store:",l),e(l);const T=B.getState().getRoleName(l.role);console.log("User role:",T),B.getState().hasRole(l,j.ADMIN)||B.getState().hasRole(l,j.INSTRUCTOR)?a("/dashboard"):a("/")}catch(u){console.error("Authentication error:",u),s({title:"Authentication error",description:u.message||"There was a problem with your authentication",variant:"destructive"})}},onError:r=>{s({title:"Google login failed",description:r.message||"Failed to complete Google authentication",variant:"destructive"}),a("/signin")}}),useSendVerifyEmail:()=>he({queryKey:[$.VERIFY.SEND],queryFn:async()=>await z.get.sendVerifyEmail(),enabled:!1,onSuccess:r=>{s({title:"Verification email sent",description:(r==null?void 0:r.message)||"Please check your inbox.",variant:"success"})},onError:r=>{var u;s({title:"Failed to send verification email",description:((u=r.response)==null?void 0:u.data)||"Something went wrong. Please try again.",variant:"destructive"})}}),useVerifyEmail:(r,u={})=>he({queryKey:[$.VERIFY.GET,r],queryFn:async()=>{if(!r)throw new Error("No verification token provided");return await z.get.getVerifyEmail(r)},enabled:!!r&&u.enabled!==!1,retry:u.retry??0,refetchOnWindowFocus:u.refetchOnWindowFocus??!1,...u})}};export{pt as u};
