import{c as A,a8 as S,l as G,b as k,r as i,t as C,j as e,H as N,M as E,L as P,G as I,al as L}from"./index-Ck7e0vOi.js";import{C as T}from"./circle-alert-DQGRNOQl.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],F=A("shield",_);function B(){const[h]=S(),n=G(),{isAuthenticated:m,user:t,login:f}=k(),[l,p]=i.useState(!1),[r,j]=i.useState(!0),[g,v]=i.useState(!0),[o,c]=i.useState(null),[a,d]=i.useState(!1),{toast:u}=C();return i.useEffect(()=>{const x=sessionStorage.getItem("google_auth_pending")==="true";(async()=>{var b,y;try{if(j(!0),d(!1),c(null),h.get("issignin")==="true"||x){console.log("Processing Google sign-in flow with direct user data fetch"),sessionStorage.removeItem("google_auth_pending");try{const s=await L.get.me();if(console.log("User response from /me API:",s),s.code!==200)throw new Error(s.message||"Failed to retrieve user profile");const w=s.data;if(w)await f(w),p(!0);else throw new Error("No user data found in response")}catch(s){console.error("Error getting user data:",s),d(!0),c(s),u({title:"Profile error",description:s.message||"Failed to retrieve your profile",variant:"destructive"})}}else{console.log("No issignin parameter or pending flag, using regular callback flow");try{const s=await refetch();if(s.error||!s.data||s.data.code!==200)throw new Error(((b=s.error)==null?void 0:b.message)||((y=s.data)==null?void 0:y.message)||"Google authentication failed")}catch(s){console.error("Error in refetch:",s),d(!0),c(s),u({title:"Authentication error",description:s.message||"Failed to complete Google sign-in",variant:"destructive"})}}}catch(s){console.error("Unexpected error in Google callback:",s),d(!0),c(s),u({title:"Authentication error",description:s.message||"An unexpected error occurred during sign-in",variant:"destructive"})}finally{j(!1),v(!1)}})()},[h,f,u]),i.useEffect(()=>{if(m&&t&&!r&&!g&&!a){p(!0),console.log("Authentication completed successfully, preparing to redirect");const x=setTimeout(()=>{console.log("Redirecting user based on role:",t.role),t.role===0?n("/"):t.role===1?n("/task-designer"):t.role===2?n("/admin"):n("/")},2500);return()=>clearTimeout(x)}},[m,t,r,g,a,n]),console.log("GoogleCallback render state:",{isLoading:r,isError:a,error:o,authCheckComplete:l,processingAuth:g,user:t,isAuthenticated:m}),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-amber-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-xl p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-primary-yellow to-secondary-yellow rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(F,{className:"w-8 h-8 text-white"})}),e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:[r&&"Completing Google Sign In",a&&"Authentication Failed",l&&"Welcome Back!",!r&&!a&&!l&&"Processing Account"]}),e.jsxs("p",{className:"text-gray-600 text-sm",children:[r&&"Securely connecting with Google",a&&"There was an issue with your sign-in",l&&"Successfully authenticated with Google",!r&&!a&&!l&&"Setting up your session"]})]}),(r||!a&&!l)&&e.jsxs("div",{className:"flex flex-col items-center space-y-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-primary-yellow border-t-transparent"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(N,{className:"h-6 w-6 text-primary-yellow"})})]}),e.jsxs("div",{className:"w-full space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between text-sm",children:e.jsx("span",{className:"text-gray-600",children:r?"Verifying Google account":"Setting up profile"})}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-primary-yellow to-secondary-yellow h-2 rounded-full transition-all duration-1000",style:{width:r?"60%":"90%"}})})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 w-full",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(E,{className:"w-4 h-4 text-blue-600 animate-spin"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-blue-800",children:r?"Authenticating with Google...":"Finalizing your session..."}),e.jsx("p",{className:"text-xs text-blue-600",children:"This may take a few moments"})]})]})})]}),a&&e.jsxs("div",{className:"flex flex-col items-center space-y-6",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(T,{className:"w-8 h-8 text-red-600"})}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 w-full",children:[e.jsx("p",{className:"text-red-800 text-sm font-medium mb-2",children:(o==null?void 0:o.message)||"Authentication failed"}),e.jsx("p",{className:"text-red-600 text-xs",children:"Please try signing in again or contact support if the issue persists."})]}),e.jsx(P,{to:"/signin",className:"w-full bg-red-500 text-white py-3 px-6 rounded-lg hover:bg-red-600 transition-colors font-medium",children:"Return to Sign In"})]}),l&&e.jsxs("div",{className:"flex flex-col items-center space-y-6",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(I,{className:"w-8 h-8 text-green-600"})}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-green-800 font-medium mb-2",children:["Welcome back",t!=null&&t.name?`, ${t.name}`:"","!"]}),e.jsx("p",{className:"text-green-600 text-sm mb-4",children:"You've been successfully signed in with Google."}),t&&e.jsxs("div",{className:"flex items-center justify-center space-x-3 p-3 bg-white rounded-lg",children:[t.avatar?e.jsx("img",{src:t.avatar,alt:"Profile",className:"w-10 h-10 rounded-full"}):e.jsx("div",{className:"w-10 h-10 bg-primary-yellow rounded-full flex items-center justify-center",children:e.jsx(N,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800",children:t.name||t.email}),e.jsx("p",{className:"text-xs text-gray-500",children:t.role===0?"Student":t.role===1?"Task Designer":t.role===2?"Admin":"User"})]})]})]})}),e.jsxs("div",{className:"w-full",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Redirecting to your dashboard..."}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full animate-pulse"})})]})]}),e.jsx("div",{className:"mt-8 pt-6 border-t border-gray-100",children:e.jsx("p",{className:"text-xs text-gray-500",children:"Secured by Google Authentication"})})]})})})}export{B as default};
