import{a3 as A,l as I,b,r as g,p as k,j as n,D as G,T as N,ad as R}from"./index-DMm_4y0p.js";/*! js-cookie v3.0.5 | MIT */function w(o){for(var i=1;i<arguments.length;i++){var u=arguments[i];for(var a in u)o[a]=u[a]}return o}var P={read:function(o){return o[0]==='"'&&(o=o.slice(1,-1)),o.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(o){return encodeURIComponent(o).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function j(o,i){function u(t,c,r){if(!(typeof document>"u")){r=w({},i,r),typeof r.expires=="number"&&(r.expires=new Date(Date.now()+r.expires*864e5)),r.expires&&(r.expires=r.expires.toUTCString()),t=encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var s="";for(var l in r)r[l]&&(s+="; "+l,r[l]!==!0&&(s+="="+r[l].split(";")[0]));return document.cookie=t+"="+o.write(c,t)+s}}function a(t){if(!(typeof document>"u"||arguments.length&&!t)){for(var c=document.cookie?document.cookie.split("; "):[],r={},s=0;s<c.length;s++){var l=c[s].split("="),f=l.slice(1).join("=");try{var m=decodeURIComponent(l[0]);if(r[m]=o.read(f,m),t===m)break}catch{}}return t?r[t]:r}}return Object.create({set:u,get:a,remove:function(t,c){u(t,"",w({},c,{expires:-1}))},withAttributes:function(t){return j(this.converter,w({},this.attributes,t))},withConverter:function(t){return j(w({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(i)},converter:{value:Object.freeze(o)}})}j(P,{path:"/"});function D(){const[o]=A(),i=I(),{isAuthenticated:u,user:a,login:t}=b(),[c,r]=g.useState(!1),[s,l]=g.useState(!0),[f,m]=g.useState(!0),[h,p]=g.useState(null),[d,x]=g.useState(!1),{toast:v}=k();return g.useEffect(()=>{const y=sessionStorage.getItem("google_auth_pending")==="true";(async()=>{var C,E;try{if(l(!0),x(!1),p(null),o.get("issignin")==="true"||y){console.log("Processing Google sign-in flow with direct user data fetch"),sessionStorage.removeItem("google_auth_pending");try{const e=await R.get.me();if(console.log("User response from /me API:",e),e.code!==200)throw new Error(e.message||"Failed to retrieve user profile");const S=e.data;if(S)await t(S),r(!0);else throw new Error("No user data found in response")}catch(e){console.error("Error getting user data:",e),x(!0),p(e),v({title:"Profile error",description:e.message||"Failed to retrieve your profile",variant:"destructive"})}}else{console.log("No issignin parameter or pending flag, using regular callback flow");try{const e=await refetch();if(e.error||!e.data||e.data.code!==200)throw new Error(((C=e.error)==null?void 0:C.message)||((E=e.data)==null?void 0:E.message)||"Google authentication failed")}catch(e){console.error("Error in refetch:",e),x(!0),p(e),v({title:"Authentication error",description:e.message||"Failed to complete Google sign-in",variant:"destructive"})}}}catch(e){console.error("Unexpected error in Google callback:",e),x(!0),p(e),v({title:"Authentication error",description:e.message||"An unexpected error occurred during sign-in",variant:"destructive"})}finally{l(!1),m(!1)}})()},[o,t,v]),g.useEffect(()=>{if(u&&a&&!s&&!f&&!d){r(!0),console.log("Authentication completed successfully, preparing to redirect");const y=setTimeout(()=>{console.log("Redirecting user based on role:",a.role),a.role===0?i("/"):a.role===1?i("/task-designer"):a.role===2?i("/admin"):i("/")},2500);return()=>clearTimeout(y)}},[u,a,s,f,d,i]),console.log("GoogleCallback render state:",{isLoading:s,isError:d,error:h,authCheckComplete:c,processingAuth:f,user:a,isAuthenticated:u}),n.jsx("div",{className:"flex items-center justify-center min-h-screen bg-primary-white",children:n.jsx("div",{className:"w-full max-w-md p-8 bg-white rounded-lg shadow-lg",children:n.jsxs("div",{className:"text-center",children:[n.jsxs("h2",{className:"text-2xl font-bold text-primary-yellow mb-4",children:[s?"Completing Google Sign In...":"",d?"Sign In Failed":"",c?"Sign In Successful!":"",!s&&!d&&!c?"Processing...":""]}),(s||!d&&!c)&&n.jsxs("div",{className:"flex flex-col items-center",children:[n.jsx(G,{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-yellow mb-4"}),n.jsx("p",{className:"text-gray-600 mt-2",children:s?"Verifying your Google account...":"Setting up your profile..."})]}),d&&n.jsxs("div",{className:"text-red-600 mt-4",children:[n.jsx("p",{children:(h==null?void 0:h.message)||(googleRefetchErrorData==null?void 0:googleRefetchErrorData.message)||"An error occurred during sign in. Please try again."}),n.jsx(Link,{to:"/signin",className:`${N.HIGHLIGHT_FRAME}`,children:"Return to Sign In"})]}),c&&n.jsxs("div",{className:"text-green-600 mt-4",children:[n.jsxs("p",{className:"mb-4",children:["You've been successfully signed in with Google!",n.jsx("br",{}),"Redirecting you to dashboard..."]}),n.jsx("div",{className:"flex justify-center",children:n.jsx("div",{className:"animate-pulse h-2 w-24 bg-primary-yellow rounded"})})]})]})})})}export{D as default};
