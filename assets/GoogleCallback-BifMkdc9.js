import{h as S,e as A,a as I,r as g,g as N,j as n,k as G,Q as R}from"./index-2JyhY2r6.js";/*! js-cookie v3.0.5 | MIT */function w(t){for(var i=1;i<arguments.length;i++){var d=arguments[i];for(var a in d)t[a]=d[a]}return t}var P={read:function(t){return t[0]==='"'&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function j(t,i){function d(o,c,r){if(!(typeof document>"u")){r=w({},i,r),typeof r.expires=="number"&&(r.expires=new Date(Date.now()+r.expires*864e5)),r.expires&&(r.expires=r.expires.toUTCString()),o=encodeURIComponent(o).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var s="";for(var l in r)r[l]&&(s+="; "+l,r[l]!==!0&&(s+="="+r[l].split(";")[0]));return document.cookie=o+"="+t.write(c,o)+s}}function a(o){if(!(typeof document>"u"||arguments.length&&!o)){for(var c=document.cookie?document.cookie.split("; "):[],r={},s=0;s<c.length;s++){var l=c[s].split("="),f=l.slice(1).join("=");try{var h=decodeURIComponent(l[0]);if(r[h]=t.read(f,h),o===h)break}catch{}}return o?r[o]:r}}return Object.create({set:d,get:a,remove:function(o,c){d(o,"",w({},c,{expires:-1}))},withAttributes:function(o){return j(this.converter,w({},this.attributes,o))},withConverter:function(o){return j(w({},this.converter,o),this.attributes)}},{attributes:{value:Object.freeze(i)},converter:{value:Object.freeze(t)}})}var U=j(P,{path:"/"});function T(){const[t]=S(),i=A(),{isAuthenticated:d,user:a,login:o}=I(),[c,r]=g.useState(!1),[s,l]=g.useState(!0),[f,h]=g.useState(!0),[m,p]=g.useState(null),[u,x]=g.useState(!1),{toast:v}=N();return g.useEffect(()=>{const y=sessionStorage.getItem("google_auth_pending")==="true",C=U.get("TK");console.log("Cookie 1 value:",C),(async()=>{var b,k;try{if(l(!0),x(!1),p(null),t.get("issignin")==="true"||y){console.log("Processing Google sign-in flow with direct user data fetch"),console.log("Cookie 2 value:",C),sessionStorage.removeItem("google_auth_pending");try{console.log("Cookie 3 value:",C),console.log(2);const e=await R.get.me();if(console.log("User response from /me API:",e),e.code!==200)throw new Error(e.message||"Failed to retrieve user profile");const E=e.data;if(E)await o(E),r(!0);else throw new Error("No user data found in response")}catch(e){console.error("Error getting user data:",e),x(!0),p(e),v({title:"Profile error",description:e.message||"Failed to retrieve your profile",variant:"destructive"})}}else{console.log("No issignin parameter or pending flag, using regular callback flow");try{const e=await refetch();if(e.error||!e.data||e.data.code!==200)throw new Error(((b=e.error)==null?void 0:b.message)||((k=e.data)==null?void 0:k.message)||"Google authentication failed")}catch(e){console.error("Error in refetch:",e),x(!0),p(e),v({title:"Authentication error",description:e.message||"Failed to complete Google sign-in",variant:"destructive"})}}}catch(e){console.error("Unexpected error in Google callback:",e),x(!0),p(e),v({title:"Authentication error",description:e.message||"An unexpected error occurred during sign-in",variant:"destructive"})}finally{l(!1),h(!1)}})()},[t,o,v]),g.useEffect(()=>{if(d&&a&&!s&&!f&&!u){r(!0),console.log("Authentication completed successfully, preparing to redirect");const y=setTimeout(()=>{console.log("Redirecting user based on role:",a.role),a.role===1?i("/dashboard"):a.role===3?i("/task-designer"):a.role===2?i("/dashboard"):i("/")},2500);return()=>clearTimeout(y)}},[d,a,s,f,u,i]),console.log("GoogleCallback render state:",{isLoading:s,isError:u,error:m,authCheckComplete:c,processingAuth:f,user:a,isAuthenticated:d}),n.jsx("div",{className:"flex items-center justify-center min-h-screen bg-primary-white",children:n.jsx("div",{className:"w-full max-w-md p-8 bg-white rounded-lg shadow-lg",children:n.jsxs("div",{className:"text-center",children:[n.jsxs("h2",{className:"text-2xl font-bold text-primary-yellow mb-4",children:[s?"Completing Google Sign In...":"",u?"Sign In Failed":"",c?"Sign In Successful!":"",!s&&!u&&!c?"Processing...":""]}),(s||!u&&!c)&&n.jsxs("div",{className:"flex flex-col items-center",children:[n.jsx(G,{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-yellow mb-4"}),n.jsx("p",{className:"text-gray-600 mt-2",children:s?"Verifying your Google account...":"Setting up your profile..."})]}),u&&n.jsxs("div",{className:"text-red-600 mt-4",children:[n.jsx("p",{children:(m==null?void 0:m.message)||(googleRefetchErrorData==null?void 0:googleRefetchErrorData.message)||"An error occurred during sign in. Please try again."}),n.jsx("button",{onClick:()=>window.location.href="/signin",className:"mt-4 px-4 py-2 bg-primary-yellow text-white rounded-md hover:bg-secondary-yellow transition-colors",children:"Return to Sign In"})]}),c&&n.jsxs("div",{className:"text-green-600 mt-4",children:[n.jsxs("p",{className:"mb-4",children:["You've been successfully signed in with Google!",n.jsx("br",{}),"Redirecting you to dashboard..."]}),n.jsx("div",{className:"flex justify-center",children:n.jsx("div",{className:"animate-pulse h-2 w-24 bg-primary-yellow rounded"})})]})]})})})}export{T as default};
